---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: patchplans.kangalpatch.ozalp.dk
spec:
  group: kangalpatch.ozalp.dk
  names:
    kind: PatchPlan
    listKind: PatchPlanList
    plural: patchplans
    singular: patchplan
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.targetVersion
      name: Target
      type: string
    - jsonPath: .status.totalNodes
      name: Total
      type: integer
    - jsonPath: .status.completedNodes
      name: Completed
      type: integer
    - jsonPath: .status.failedNodes
      name: Failed
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: PatchPlan is the Schema for the patchplans API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: PatchPlanSpec defines the desired state of PatchPlan
            properties:
              controlPlaneFirst:
                default: false
                description: ControlPlaneFirst indicates whether to patch control
                  plane before workers
                type: boolean
              delayBetweenNodes:
                default: 5m
                description: DelayBetweenNodes is the delay between patching individual
                  nodes (e.g., "30s", "2m")
                pattern: ^([0-9]+(\.[0-9]+)?(s|m|h))+$
                type: string
              drainTimeout:
                default: 5m
                description: DrainTimeout is the maximum time to wait for node drain
                type: string
              maxConcurrency:
                default: 1
                description: MaxConcurrency is the maximum number of nodes to patch
                  concurrently
                minimum: 1
                type: integer
              maxFailures:
                default: 0
                description: |-
                  MaxFailures is the maximum number of failed nodes before the plan stops.
                  Default is 0 (fail on first failure).
                minimum: 0
                type: integer
              nodeSelector:
                additionalProperties:
                  type: string
                description: NodeSelector selects which nodes to patch (label selector)
                type: object
              patchControlPlane:
                default: true
                description: PatchControlPlane indicates whether to patch control
                  plane nodes
                type: boolean
              patchWorkers:
                default: true
                description: PatchWorkers indicates whether to patch worker nodes
                type: boolean
              paused:
                default: false
                description: Paused pauses the patching operation
                type: boolean
              rebootTimeout:
                default: 10m
                description: RebootTimeout is the maximum time to wait for node to
                  reboot and become ready
                type: string
              respectPDBs:
                default: true
                description: RespectPDBs indicates whether to respect PodDisruptionBudgets
                  during node drain
                type: boolean
              talosConfig:
                description: TalosConfig contains Talos API connection information
                properties:
                  caCert:
                    description: CACert is the CA certificate for Talos API (base64
                      encoded)
                    type: string
                  clientCert:
                    description: ClientCert is the client certificate for Talos API
                      (base64 encoded)
                    type: string
                  clientKey:
                    description: ClientKey is the client key for Talos API (base64
                      encoded)
                    type: string
                  endpoints:
                    description: Endpoints is a list of Talos API endpoints
                    items:
                      type: string
                    type: array
                  secretRef:
                    description: SecretRef references a Secret containing Talos credentials
                    properties:
                      name:
                        description: Name is the name of the secret
                        type: string
                      namespace:
                        description: Namespace is the namespace of the secret
                        type: string
                    required:
                    - name
                    type: object
                type: object
              targetVersion:
                description: TargetVersion is the Talos version to upgrade to
                type: string
            required:
            - targetVersion
            type: object
          status:
            description: PatchPlanStatus defines the observed state of PatchPlan
            properties:
              completedNodes:
                default: 0
                description: CompletedNodes is the number of nodes successfully patched
                  (derived from PatchJobs)
                type: integer
              completionTime:
                description: CompletionTime is when the patching operation completed
                format: date-time
                type: string
              conditions:
                description: Conditions represent the latest available observations
                  of the PatchPlan's state
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              failedNodes:
                default: 0
                description: FailedNodes is the number of nodes that failed to patch
                  (derived from PatchJobs)
                type: integer
              lastNodeScheduledAt:
                description: |-
                  LastNodeScheduledAt is when the last PatchJob was created
                  Used to enforce DelayBetweenNodes
                format: date-time
                type: string
              message:
                description: Message contains human-readable message about current
                  state
                type: string
              phase:
                description: Phase represents the current phase of the patching operation
                enum:
                - Pending
                - InProgress
                - Paused
                - Completed
                - Failed
                type: string
              startTime:
                description: StartTime is when the patching operation started
                format: date-time
                type: string
              targetVersion:
                description: TargetVersion is the display version extracted from spec.targetVersion
                type: string
              totalNodes:
                description: TotalNodes is the total number of nodes selected for
                  patching
                type: integer
            required:
            - completedNodes
            - failedNodes
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
